
이번 시간에는 Bash operator를 한번 더 써보려고 합니다.
저번 시간에 Bash operator의 특징 중 하나가 쉘 명령을 실행시키는 주체가 컨테이너라고 했어요. 
그런데 보통은 .sh 로 명명된 외부 쉘 파일을 실행시켜야 하는 경우가 매우 많습니다. 

저번과는 다르게 컨테이너 외부에 존재하는 쉘 프로그램을 실행시키는 방법에 대해서 알아보겠습니다. 
먼저 컨테이너가 쉘 파일을 인식할 수 있는 방법을 생각해봐야 하는데요.
예전 강의에서 yaml 파일에서 wsl 디렉토리와 컨테이너 디렉토리간 연결하는 방법에 대해서 봤습니다. 
그 파일을 다시 열어볼께요. 
보시면 dags 폴더, logs폴더, plugins 폴더가 있는데요. dags 는 dag 저장하는 폴더이고, logs 폴더는 컨테이너가 생성하는 로그 파일들이 저장되는 장소입니다. 그다음 plugins 폴더가 있는데, 원래 이 plugins 폴더의 용도는 dag을 만드는데 필요한 부가적인 파이썬 파일이 있으면 여기에 갖다놓으라는 용도의 폴더입니다. 

그리고 파이썬 파일 뿐만 아니라 쉘 파일 같은것도 여기에 위치시키면 airflow 컨테이너가 그 파일을 인식할 수 있게 되요. 
그럼 ./plugins 폴더에다가 쉘 파일을 넣어주면 되긴 하는데 
dag 파일과 비슷한 문제가 하나 있습니다. 
./plugins 에다가 쉘 프로그램을 작성하면 이 디렉토리는 git 연동된 디렉토리가 아니기 때문에 다른 사람들이 git pull 해도 이 파일을 공유받지 못한다는 겁니다.  

우리는 git 을 통해서 데이터를 공유하는데 git 디렉토리는 airflow죠? 그 밑에 dags가 있었습니다. 
그래서 이번엔 plugins 폴더를 만들고 이 plugins 폴더를 컨테이너와 연결하도록 할께요. 
그럼 plugins 폴더가 git 을 통해서 데이터 공유도 되고 컨테이너와 연결도 가능한거에요.

plugins 폴더 만드는건 wsl 상에서 해볼꼐요.
cd airflow 로 airflow 로 이동하시고
mkdir plugins 해보겠습니다. 
그리고 그 밑에 shell 폴더 하나 만들께요. cd plugins; mkdir shell ; cd shell 
이제 여기다가 쉘 프로그램 하나 만들어볼게요. 
vi select_fruit.sh 이라고 치겠습니다. 

사용자가 입력한 과일에 대해서 echo 남기는 간단한 프로그램을 작성할거에요. 

FRUIT=$1  
FRUIT=`echo $FRUIT | tr '[:lower:]' '[:upper:]'`  
if [ $FRUIT == APPLE ];then  
 echo "You selected Apple!"  
elif [ $FRUIT == ORANGE ];then  
 echo "You selected Orange!"  
elif [ $FRUIT == GRAPE ];then  
 echo "You selected Grape!"  
else  
 echo "You selected other Fruit!"  
fi


이렇게 작성하고 저장하고 나올께요. 
git status 쳐보시면 방금 작성한 sh 파일이 나오죠? 이걸 push 해두겠습니다. 

git push

그리고 yaml 파일을 열어서 plugins 폴더 연결을 바꿔주도록 할께요.
volumes 항목을  ${AIRFLOW_PROJ_DIR:-.}/airflow/plugins:/opt/airflow/plugins 이렇게 바꿔볼께요.

그리고 airflow 를 재시작하겠습니다. 

(airflow 재시작)
이렇게 하고나면 이제 컨테이너는 .sh 파일을 볼 수가 있습니다.
한번 확인해볼까요? 
sudo docker exec -it 워커ID bash 입력해서 워커 컨테이너로 들어가볼께요. 

여기서 cd /opt/airflow/plugins 치면 뭐가 있나요? shell 디렉토리가 있네요 cd shell 디렉토리 안에는 우리가 wsl 상에서 만든 .sh 파일이 있습니다. 
즉 컨테이너도 plugins 폴더 연결을 통해서 쉘 파일을 바라보고 있는 상태인 것이죠. 

한가지 퀴즈 나가겠습니다.
혹시 이 컨테이너 안에서 쉘 프로그램을 작성해두면 안되나요?
라고 궁금할 수 있습니다.
그런데 컨테이너는 종료와 동시에 가지고 있는 데이터는 모두 삭제됩니다. 
따라서 컨테이너 안에 쉘 프로그램을 만들어둔다면 컨테이너 종료시 모두 삭제되는 것이죠. 

삭제되는 걸 방지하려면 어떻게 해야할까요?
바로 wsl 디렉토리하고 연결해두는 겁니다. ./logs 폴더의 로그는 airflow 컨테이너 생성하는건데, wsl의 ./logs와 연결되어 있기 때문에 컨테이너가 종료되어도 wsl 디렉토리에 로그 데이터가 남게 되는겁니다. 

그래서 컨테이너가 종료되어도 데이터가 남아있게 하면서 컨테이너에게 파일을 공유하려면 이렇게 volumes 항목으로 마운트된 경로에 데이터를 만들어두어야 합니다. 

이제 이 쉘 파일을 수행하도록 dag을 만들어보겠습니다. 
